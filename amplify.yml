version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - pnpm install
    build:
      commands:
        - echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env.local
        - echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY" >> .env.local
        # 静的ファイルを事前に準備
        - mkdir -p public/static
        - touch public/static/.placeholder
        # ビルド実行
        - pnpm run build
        # 静的ファイルの配置を確認
        - ls -la out/
        # インデックスファイルのコピー
        - cp public/index.html out/ || echo "index.html already exists"
        # 404ページの準備
        - cp public/404.html out/404.html || echo "Creating default 404 page"
        - test -f out/404.html || echo "<html><body><h1>Page Not Found</h1></body></html>" > out/404.html
        # Amplifyのデプロイエラー対策 - 改善版
        - mkdir -p out/.next/server
        - echo '{"middleware":{},"functions":{},"version":1}' > out/.next/server/middleware-manifest.json
        - echo '{"config":{"configFile":"next.config.js","trailingSlash":true,"output":"export"},"pages":{}}' > out/required-server-files.json
        # 静的ファイルの確認
        - find out -type f | sort
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=0, must-revalidate'
